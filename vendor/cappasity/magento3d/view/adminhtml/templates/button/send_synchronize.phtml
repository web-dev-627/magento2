<?php if ($token = $block->getActiveToken()) : ?>
    <?php $loading = $block->loadActiveSyncJob(); ?>
    <button type="button" class="action- scalable save primary js-button-send-synchronize">
        <span><?= /* @noEscape */ __('Synchronize'); ?></span>
    </button>
    <div class="synchronize-status">
        <?= /* @noEscape */ __('Synchronization in progress'); ?>
    </div>
    <script>
        require([
            'jquery',
            'Magento_Ui/js/modal/alert',
            'mage/translate'
        ], function ($, alert) {

            var colors = {
                'danger': '#d9534f',
                'warning': '#f0ad4e',
                'info': '#5bc0de',
                'success': '#5cb85c'
            };
            var showMessage = function(text, type) {
                alert({
                    title: "Synchronization",
                    content: "<div class=\"progress\" style=\"\n" +
                    "    overflow: hidden;\n" +
                    "    height: 20px;\n" +
                    "    margin-bottom: 20px;\n" +
                    "    background-color: #f5f5f5;\n" +
                    "    border-radius: 0px;\n" +
                    "    -webkit-box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);\n" +
                    "    box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);\">\n" +
                    "    <div class=\"progress-bar ng-binding\"\n" +
                    "         role=\"progressbar\"\n" +
                    "         aria-valuenow=\"0\"\n" +
                    "         aria-valuemin=\"0\"\n" +
                    "         aria-valuemax=\"100\"\n" +
                    "         style=\"\n" +
                    "            width:0;\n" +
                    "             float: left;\n" +
                    "             height: 100%;\n" +
                    "             font-size: 12px;\n" +
                    "             line-height: 20px;\n" +
                    "             color: #fff;\n" +
                    "             text-align: center;\n" +
                    "             background-color: #DA4927;\n" +
                    "             -webkit-box-shadow: inset 0 -1px 0 rgba(0, 0, 0, 0.15);\n" +
                    "             box-shadow: inset 0 -1px 0 rgba(0, 0, 0, 0.15);\n" +
                    "             -webkit-transition: width 0.6s ease;\n" +
                    "             -o-transition: width 0.6s ease;\n" +
                    "             transition: width 0.6s ease;\">\n" +
                    "    </div>\n" +
                    "</div>",
                    autoOpen: true,
                    clickableOverlay: false,
                    focus: "",
                    actions: {
                        always: function () {
                        }
                    }
                });
                $('.modal-popup .modal-content').text('Error: ' + text).css('color', colors[type]);
            }

            var token = '<?= /* @noEscape */ $token;?>';
            var syncData = function (status) {
                var synchronizeStatus = $('.synchronize-status');

                $.ajax({
                    method: "GET",
                    url: '<?= /* @noEscape */ $block->getSyncDataUrl();?>',
                    data: {token: token, status: status},
                    success: function (response) {
                        if (response.type == 'success') {
                            if(response.in_progress) {
                                synchronizeStatus.addClass('in-process');
                            } else {
                                synchronizeStatus.removeClass('in-process');
                            }
                        } else {
                            showMessage(response.text, 'danger');
                        }
                    },
                });
            }

            $('.js-button-send-synchronize').on('click', function () {
                syncData();
            });

            setInterval(function () {
                syncData(true)
            }, 2000);

            syncData(true);
        });
    </script>
<?php endif; ?>