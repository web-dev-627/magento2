<?xml version="1.0"?>
<!--
/**
 * ||GEISSWEB| EU VAT Enhanced
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the GEISSWEB End User License Agreement
 * that is available through the world-wide-web at this URL: https://www.geissweb.de/legal-information/eula
 *
 * DISCLAIMER
 *
 * Do not edit this file if you wish to update the extension in the future. If you wish to customize the extension
 * for your needs please refer to our support for more information.
 *
 * @copyright   Copyright (c) 2015 GEISS WeblÃ¶sungen (https://www.geissweb.de)
 * @license     https://www.geissweb.de/legal-information/eula GEISSWEB End User License Agreement
 */
-->
<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="urn:magento:framework:ObjectManager/etc/config.xsd">

    <!-- Custom Logger -->
    <type name="Geissweb\Euvat\Logger\Handler">
        <arguments>
            <argument name="filesystem" xsi:type="object">Magento\Framework\Filesystem\Driver\File</argument>
        </arguments>
    </type>
    <type name="Geissweb\Euvat\Logger\Logger">
        <arguments>
            <argument name="name" xsi:type="string">VAT</argument>
            <argument name="handlers"  xsi:type="array">
                <item name="debug" xsi:type="object">Geissweb\Euvat\Logger\Handler</item>
            </argument>
        </arguments>
    </type>

    <!-- Rewrites to prevent Magento core VAT validation execution -->
    <preference for="Magento\Customer\Observer\BeforeAddressSaveObserver"
                type="Geissweb\Euvat\Observer\BeforeAddressSaveObserver"/>

    <preference for="Magento\Customer\Observer\AfterAddressSaveObserver"
                type="Geissweb\Euvat\Observer\AfterAddressSaveObserver"/>

    <!-- Plugin and arguments -->
    <type name="Magento\Tax\Model\Calculation">
        <arguments>
            <argument name="data" xsi:type="array">
                <item name="euvat_logger" xsi:type="object">Geissweb\Euvat\Logger\Logger</item>
                <item name="euvat_current_tax_country_registry" xsi:type="object">Geissweb\Euvat\Registry\CurrentTaxCountry</item>
                <item name="euvat_config" xsi:type="object">Geissweb\Euvat\Helper\Configuration</item>
            </argument>
        </arguments>
        <!-- Dynamic tax class -->
        <plugin name="Geissweb_TaxCalculation" type="Geissweb\Euvat\Plugin\Tax\Calculation" sortOrder="10" disabled="false" />
    </type>

    <!-- Rewrite tax calculation model -->
    <preference for="Magento\Tax\Model\Calculation"
                type="Geissweb\Euvat\Model\Rewrite\TaxCalculation"/>


    <!-- Adjust Default Checkout Layout -->
    <type name="Magento\Checkout\Block\Checkout\LayoutProcessor">
        <plugin name="Geissweb_VatNumberCheckoutLayout" type="Geissweb\Euvat\Plugin\CheckoutLayout\DefaultCheckout" sortOrder="20" disabled="false"/>
    </type>

    <!-- Adjust Mageplaza_Osc Checkout Layout -->
    <type name="Mageplaza\Osc\Block\Checkout\LayoutProcessor">
        <plugin name="Geissweb_VatNumberCheckoutLayoutMageplaza" type="Geissweb\Euvat\Plugin\CheckoutLayout\MageplazaOsc" sortOrder="10" disabled="false"/>
    </type>

    <!-- Aheadworks OneStepCheckout -->
    <type name="Aheadworks\OneStepCheckout\Block\Checkout">
        <plugin name="Geissweb_VatNumberCheckoutLayoutAheadworks" type="Geissweb\Euvat\Plugin\CheckoutLayout\AheadworksOsc" sortOrder="10" disabled="false"/>
    </type>

    <!-- Plugin for tax config -->
    <type name="Magento\Tax\Model\Config">
        <plugin name="Geissweb_TaxConfig" type="Geissweb\Euvat\Plugin\Tax\Config" sortOrder="10" disabled="false" />
    </type>

    <!-- Make sure quote address uses existing values -->
    <type name="Magento\Tax\Model\Sales\Total\Quote\CommonTaxCollector">
        <plugin name="Geissweb_QuoteTaxCollector" type="Geissweb\Euvat\Plugin\Tax\QuoteCollector" sortOrder="10" disabled="false" />
    </type>

    <!-- Plugin for assigning customer group -->
    <type name="Magento\Customer\Model\ResourceModel\CustomerRepository">
        <plugin name="Geissweb_CustomerRepository" type="Geissweb\Euvat\Plugin\CustomerRepository" sortOrder="10" disabled="false"/>
    </type>

    <preference for="Geissweb\Euvat\Api\Data\ValidationSearchResultsInterface"
                type="Geissweb\Euvat\Model\ValidationSearchResults"/>

    <!-- Assigns customer group to guest orders (if enabled) and adds order comment with validation information -->
    <type name="Magento\Sales\Api\OrderManagementInterface">
        <plugin name="Geissweb_OrderManagement" type="Geissweb\Euvat\Plugin\OrderManagement" sortOrder="10" disabled="false"/>
    </type>

    <!-- Fix trigger_recollect on quote loading -->
    <type name="Magento\Quote\Model\Quote">
        <plugin name="Geissweb_RecollectFix" type="Geissweb\Euvat\Plugin\Model\Quote" />
    </type>

    <!-- Console commands -->
    <type name="Magento\Framework\Console\CommandList">
        <arguments>
            <argument name="commands" xsi:type="array">
                <item name="CleanVatNumbers" xsi:type="object">Geissweb\Euvat\Console\Command\CleanVatNumbers</item>
            </argument>
        </arguments>
    </type>

    <!-- Admin Grid for VAT Validations List (must not go to adminhtml/di.xml) -->
    <preference for="Geissweb\Euvat\Api\ValidationRepositoryInterface" type="Geissweb\Euvat\Model\ValidationRepository"/>
    <preference for="Geissweb\Euvat\Api\Data\ValidationInterface" type="Geissweb\Euvat\Model\Data\Validation"/>
    <preference for="Geissweb\Euvat\Api\Data\ValidationSearchResultsInterface" type="Magento\Framework\Api\SearchResults"/>
    <virtualType name="Geissweb\Euvat\Model\ResourceModel\Validation\Grid\Collection"
                 type="Magento\Framework\View\Element\UiComponent\DataProvider\SearchResult">
        <arguments>
            <argument name="mainTable" xsi:type="string">vat_validation</argument>
            <argument name="resourceModel" xsi:type="string">
                Geissweb\Euvat\Model\ResourceModel\Validation\Collection
            </argument>
        </arguments>
    </virtualType>
    <type name="Magento\Framework\View\Element\UiComponent\DataProvider\CollectionFactory">
        <arguments>
            <argument name="collections" xsi:type="array">
                <item name="euvat_validation_listing_data_source" xsi:type="string">
                    Geissweb\Euvat\Model\ResourceModel\Validation\Grid\Collection
                </item>
            </argument>
        </arguments>
    </type>

</config>
